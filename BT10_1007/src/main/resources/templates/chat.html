<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat H·ªó Tr·ª£ Kh√°ch H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100 justify-content-center">
            <!-- Chat Area -->
            <div class="col-lg-8 col-md-10 col-sm-11 p-0">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">üí¨ Chat H·ªó Tr·ª£ Kh√°ch H√†ng</h4>
                                <small>Vai tr√≤: <span th:text="${role}"></span> | T√™n: <span th:text="${username}"></span></small>
                            </div>
                            <a href="/" class="btn btn-light btn-sm">‚Üê Quay l·∫°i</a>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be displayed here -->
                    </div>
                    
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Nh·∫≠p tin nh·∫Øn..." 
                                   th:value="${username}">
                            <button class="btn btn-primary" type="button" id="sendButton">
                                G·ª≠i
                            </button>
                        </div>
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <span id="typingText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        const username = /*[[${username}]]*/ 'Guest';
        const role = /*[[${role}]]*/ 'CUSTOMER';
        let stompClient = null;
        let typingTimer = null;
        let isTyping = false;

        // K·∫øt n·ªëi WebSocket
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                
                // Subscribe to public messages
                stompClient.subscribe('/topic/public', function (message) {
                    const chatMessage = JSON.parse(message.body);
                    displayMessage(chatMessage);
                });
                
                // Join chat
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    sender: username,
                    type: 'JOIN'
                }));
            });
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn
        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                messageElement.className = 'join-leave-message';
                messageElement.innerHTML = `‚ÑπÔ∏è ${message.content}`;
            } else if (message.type === 'TYPING') {
                const typingIndicator = document.getElementById('typingIndicator');
                const typingText = document.getElementById('typingText');
                typingText.textContent = `${message.sender} ƒëang g√µ...`;
                typingIndicator.style.display = 'block';
                
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                }, 3000);
                return;
            } else if (message.type === 'STOP_TYPING') {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.style.display = 'none';
                return;
            } else {
                // Tin nh·∫Øn th∆∞·ªùng
                const isOwnMessage = message.sender === username;
                messageElement.className = `message ${isOwnMessage ? 'own' : ''}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        <div>${message.content}</div>
                        <div class="message-info">
                            <strong>${message.sender}</strong> - ${time}
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // G·ª≠i tin nh·∫Øn
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageContent = messageInput.value.trim();
            
            if (messageContent && stompClient) {
                const chatMessage = {
                    sender: username,
                    content: messageContent,
                    type: 'CHAT'
                };
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        // X·ª≠ l√Ω typing indicator
        function handleTyping() {
            if (!isTyping && stompClient) {
                isTyping = true;
                stompClient.send("/app/chat.typing", {}, JSON.stringify({
                    sender: username,
                    type: 'TYPING'
                }));
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (isTyping && stompClient) {
                    isTyping = false;
                    stompClient.send("/app/chat.stopTyping", {}, JSON.stringify({
                        sender: username,
                        type: 'STOP_TYPING'
                    }));
                }
            }, 1000);
        }

        // Event listeners
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                handleTyping();
            }
        });

        // K·∫øt n·ªëi khi trang load
        connect();
    </script>
</body>
</html>
